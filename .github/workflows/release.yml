name: Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Override the computed release type (auto honors commit history)"
        required: true
        default: auto
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
          - none

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  tests:
    runs-on: ubuntu-latest
    env:
      GOCACHE: /tmp/agent-align-go-cache
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
      - name: Run go tests
        run: go test ./...

  verify:
    needs: tests
    runs-on: ubuntu-latest
    environment:
      name: release-approval
    outputs:
      release_type: ${{ steps.capture.outputs.release_type }}
      release_version: ${{ steps.compute-version.outputs.release_version || 'unknown' }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
      - name: Install Node dependencies
        run: npm ci
      - id: capture
        run: echo "release_type=${{ github.event.inputs.release_type || 'auto' }}" >> "$GITHUB_OUTPUT"
      - id: compute-version
        if: steps.capture.outputs.release_type != 'none'
        env:
          RELEASE_TYPE_OVERRIDE: ${{ steps.capture.outputs.release_type }}
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          NO_COLOR: 1
        run: |
          set -euo pipefail
          log=$(mktemp)
          npx semantic-release --dry-run > "$log" 2>&1 || true
          version=$(grep -o -m1 'The next release version is [^ ]*' "$log" | awk '{print $NF}' || true)
          if [ -n "$version" ]; then
            echo "release_version=$version" >> "$GITHUB_OUTPUT"
          else
            echo "release_version=unknown" >> "$GITHUB_OUTPUT"
          fi
      - name: Approval summary
        run: |
          release_type=${{ steps.capture.outputs.release_type }}
          release_version=${{ steps.compute-version.outputs.release_version || 'unknown' }}
          echo "Manual approval recorded with release_type=$release_type"
          if [ "$release_version" != "unknown" ]; then
            echo "Upcoming release version: $release_version"
          else
            echo "Release version not determined (release_type=$release_type)"
          fi

  release:
    needs: [tests, verify]
    if: ${{ needs.verify.outputs.release_type != 'none' }}
    runs-on: ubuntu-latest
    env:
      RELEASE_TYPE_OVERRIDE: ${{ needs.verify.outputs.release_type }}
      GOCACHE: /tmp/agent-align-go-cache
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
      - name: Build release binaries
        env:
          VERSION: ${{ needs.verify.outputs.release_version }}
        run: |
          set -euo pipefail
          TARGETS=(
            "linux amd64"
            "linux arm64"
            "darwin amd64"
            "darwin arm64"
            "windows amd64"
          )
          rm -rf dist
          mkdir -p dist
          for target in "${TARGETS[@]}"; do
            IFS=' ' read -r os arch <<< "$target"
            out_bin="agent-align"
            if [ "$os" = windows ]; then
              out_bin="${out_bin}.exe"
            fi
            archive="agent-align-${os}-${arch}"
            env GOOS="$os" GOARCH="$arch" CGO_ENABLED=0 go build -ldflags="-s -w -X main.version=${VERSION}" -o "dist/$out_bin" ./cmd/agent-align
            if [ "$os" = windows ]; then
              zip -j "dist/${archive}.zip" "dist/$out_bin"
              rm "dist/$out_bin"
            else
              tar -czf "dist/${archive}.tar.gz" -C dist "$out_bin"
              rm "dist/$out_bin"
            fi
          done
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
      - name: Install Node dependencies
        run: npm ci
      - name: Publish release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: npx semantic-release

      - name: Update Homebrew Tap
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          set -euo pipefail
          # Determine version (strip leading v if present)
          VERSION='${{ needs.verify.outputs.release_version }}'
          if [ -z "$VERSION" ] || [ "$VERSION" = "unknown" ]; then
            VERSION=$(git describe --tags --abbrev=0 || true)
          fi
          VER=${VERSION#v}

          echo "Updating Homebrew tap for version: $VER"

          assets=(
            "agent-align-darwin-arm64.tar.gz"
            "agent-align-darwin-amd64.tar.gz"
            "agent-align-linux-amd64.tar.gz"
            "agent-align-linux-arm64.tar.gz"
          )

          declare -A shas

          for a in "${assets[@]}"; do
            url="https://github.com/timbuchinger/agent-align/releases/download/v${VER}/${a}"
            echo "Fetching $url"
            sha=$(curl -sL "$url" | shasum -a 256 | cut -d' ' -f1)
            if [ -z "$sha" ]; then
              echo "WARNING: could not fetch $url or compute sha256"
            fi
            shas[$a]=$sha
            echo "$a -> ${shas[$a]}"
          done

          # Clone tap and update formula file
          # Use official ssh-agent action to load the private key securely
          # This expects `secrets.TAP_REPO_SSH_KEY` to contain the private key
          echo "Setting up SSH agent via action"
      - name: Setup SSH key for Homebrew tap
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.TAP_REPO_SSH_KEY }}

      - name: Clone Homebrew tap
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git clone git@github.com:timbuchinger/homebrew-tap.git
          cd homebrew-tap

          # Build new on_macos and on_linux blocks
          new_macos='on_macos do
            on_arm do
              url "https://github.com/timbuchinger/agent-align/releases/download/v#{version}/agent-align-darwin-arm64.tar.gz"
              sha256 "<DARWIN_ARM_SHA>"
            end
            on_intel do
              url "https://github.com/timbuchinger/agent-align/releases/download/v#{version}/agent-align-darwin-amd64.tar.gz"
              sha256 "<DARWIN_AMD_SHA>"
            end
          end'

          new_linux='on_linux do
            on_intel do
              url "https://github.com/timbuchinger/agent-align/releases/download/v#{version}/agent-align-linux-amd64.tar.gz"
              sha256 "<LINUX_AMD_SHA>"
            end
            on_arm do
              url "https://github.com/timbuchinger/agent-align/releases/download/v#{version}/agent-align-linux-arm64.tar.gz"
              sha256 "<LINUX_ARM_SHA>"
            end
          end'

          DARWIN_ARM_SHA=${shas["agent-align-darwin-arm64.tar.gz"]}
          DARWIN_AMD_SHA=${shas["agent-align-darwin-amd64.tar.gz"]}
          LINUX_AMD_SHA=${shas["agent-align-linux-amd64.tar.gz"]}
          LINUX_ARM_SHA=${shas["agent-align-linux-arm64.tar.gz"]}

          # Inject SHAs into template blocks (replace placeholder tokens)
          new_macos=${new_macos//<DARWIN_ARM_SHA>/$DARWIN_ARM_SHA}
          new_macos=${new_macos//<DARWIN_AMD_SHA>/$DARWIN_AMD_SHA}
          new_linux=${new_linux//<LINUX_AMD_SHA>/$LINUX_AMD_SHA}
          new_linux=${new_linux//<LINUX_ARM_SHA>/$LINUX_ARM_SHA}

          # Replace existing blocks using perl (non-greedy)
          perl -0777 -pe "s/on_macos do.*?end\n/${new_macos}\n/s" -i Formula/agent-align.rb
          perl -0777 -pe "s/on_linux do.*?end\n/${new_linux}\n/s" -i Formula/agent-align.rb

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/agent-align.rb || true
          if git diff --cached --quiet; then
            echo "No changes to formula"
          else
            git commit -m "Update agent-align to v${VER}"
            git push
          fi
