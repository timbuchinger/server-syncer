name: Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Override the computed release type (auto honors commit history)"
        required: true
        default: auto
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
          - none

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  tests:
    runs-on: ubuntu-latest
    env:
      GOCACHE: /tmp/server-syncer-go-cache
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
      - name: Run go tests
        run: go test ./...

  verify:
    needs: tests
    runs-on: ubuntu-latest
    environment:
      name: release-approval
    outputs:
      release_type: ${{ steps.capture.outputs.release_type }}
    steps:
      - name: Await approval
        run: |
          echo "Manual approval recorded with release_type=${{ github.event.inputs.release_type || 'auto' }}"
      - id: capture
        run: echo "release_type=${{ github.event.inputs.release_type || 'auto' }}" >> "$GITHUB_OUTPUT"

  release:
    needs: [tests, verify]
    if: ${{ needs.verify.outputs.release_type != 'none' }}
    runs-on: ubuntu-latest
    env:
      RELEASE_TYPE_OVERRIDE: ${{ needs.verify.outputs.release_type }}
      GOCACHE: /tmp/server-syncer-go-cache
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
      - name: Build release binaries
        run: |
          set -euo pipefail
          TARGETS=(
            "linux amd64"
            "linux arm64"
            "darwin amd64"
            "darwin arm64"
            "windows amd64"
          )
          rm -rf dist
          mkdir -p dist
          for target in "${TARGETS[@]}"; do
            IFS=' ' read -r os arch <<< "$target"
            bin="server-syncer-${os}-${arch}"
            if [ "$os" = windows ]; then
              bin="${bin}.exe"
            fi
            env GOOS="$os" GOARCH="$arch" CGO_ENABLED=0 go build -ldflags="-s -w" -o "dist/$bin" ./cmd/server-syncer
            if [ "$os" = windows ]; then
              zip -j "dist/${bin}.zip" "dist/$bin"
              rm "dist/$bin"
            else
              tar -czf "dist/${bin}.tar.gz" -C dist "$bin"
              rm "dist/$bin"
            fi
          done
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
      - name: Install Node dependencies
        run: npm ci
      - name: Publish release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
