name: Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Override the computed release type (auto honors commit history)"
        required: true
        default: auto
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
          - none

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  tests:
    runs-on: ubuntu-latest
    env:
      GOCACHE: /tmp/agent-align-go-cache
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
      - name: Run go tests
        run: go test ./...

  verify:
    needs: tests
    runs-on: ubuntu-latest
    environment:
      name: release-approval
    outputs:
      release_type: ${{ steps.capture.outputs.release_type }}
      release_version: ${{ steps.compute-version.outputs.release_version || 'unknown' }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
      - name: Install Node dependencies
        run: npm ci
      - id: capture
        run: echo "release_type=${{ github.event.inputs.release_type || 'auto' }}" >> "$GITHUB_OUTPUT"
      - id: compute-version
        if: steps.capture.outputs.release_type != 'none'
        env:
          RELEASE_TYPE_OVERRIDE: ${{ steps.capture.outputs.release_type }}
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          NO_COLOR: 1
        run: |
          set -euo pipefail
          log=$(mktemp)
          npx semantic-release --dry-run > "$log" 2>&1 || true
          version=$(grep -o -m1 'The next release version is [^ ]*' "$log" | awk '{print $NF}' || true)
          if [ -n "$version" ]; then
            echo "release_version=$version" >> "$GITHUB_OUTPUT"
          else
            echo "release_version=unknown" >> "$GITHUB_OUTPUT"
          fi
      - name: Approval summary
        run: |
          release_type=${{ steps.capture.outputs.release_type }}
          release_version=${{ steps.compute-version.outputs.release_version || 'unknown' }}
          echo "Manual approval recorded with release_type=$release_type"
          if [ "$release_version" != "unknown" ]; then
            echo "Upcoming release version: $release_version"
          else
            echo "Release version not determined (release_type=$release_type)"
          fi

  release:
    needs: [tests, verify]
    if: ${{ needs.verify.outputs.release_type != 'none' }}
    runs-on: ubuntu-latest
    env:
      RELEASE_TYPE_OVERRIDE: ${{ needs.verify.outputs.release_type }}
      GOCACHE: /tmp/agent-align-go-cache
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
      - name: Build release binaries
        env:
          VERSION: ${{ needs.verify.outputs.release_version }}
        run: |
          set -euo pipefail
          TARGETS=(
            "linux amd64"
            "linux arm64"
            "darwin amd64"
            "darwin arm64"
            "windows amd64"
          )
          rm -rf dist
          mkdir -p dist
          for target in "${TARGETS[@]}"; do
            IFS=' ' read -r os arch <<< "$target"
            bin="agent-align-${os}-${arch}"
            if [ "$os" = windows ]; then
              bin="${bin}.exe"
            fi
            env GOOS="$os" GOARCH="$arch" CGO_ENABLED=0 go build -ldflags="-s -w -X main.version=${VERSION}" -o "dist/$bin" ./cmd/agent-align
            if [ "$os" = windows ]; then
              zip -j "dist/${bin}.zip" "dist/$bin"
              rm "dist/$bin"
            else
              tar -czf "dist/${bin}.tar.gz" -C dist "$bin"
              rm "dist/$bin"
            fi
          done
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
      - name: Install Node dependencies
        run: npm ci
      - name: Publish release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: npx semantic-release
      - name: Update Homebrew formula
        env:
          VERSION: ${{ needs.verify.outputs.release_version }}
        run: ./scripts/update-brew-formula.sh "$VERSION" dist
      - name: Push Homebrew formula to tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          HOMEBREW_TAP_REPO: ${{ vars.HOMEBREW_TAP_REPO }}
        run: |
          if [ -z "$HOMEBREW_TAP_TOKEN" ] || [ -z "$HOMEBREW_TAP_REPO" ]; then
            echo "HOMEBREW_TAP_TOKEN or HOMEBREW_TAP_REPO not set, skipping Homebrew tap update"
            exit 0
          fi
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Clone the homebrew tap repository
          TEMP_DIR=$(mktemp -d)
          git clone "https://${HOMEBREW_TAP_TOKEN}@github.com/${HOMEBREW_TAP_REPO}.git" "$TEMP_DIR"
          
          # Copy the updated formula
          cp Formula/agent-align.rb "$TEMP_DIR/Formula/agent-align.rb"
          
          # Commit and push
          cd "$TEMP_DIR"
          git add Formula/agent-align.rb
          if git diff --staged --quiet; then
            echo "No changes to Homebrew formula"
          else
            git commit -m "chore: update agent-align to version ${VERSION}"
            git push origin main || git push origin master
          fi
          
          rm -rf "$TEMP_DIR"
