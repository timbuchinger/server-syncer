name: Commit Message Format

on:
  push:
    branches-ignore:
      - dependabot/**
  pull_request:

jobs:
  lint-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
      - name: Install commitlint
        run: npm ci
      - name: Ensure commit messages follow the semantic format
        run: |
          set -euo pipefail
          event_name="${{ github.event_name }}"
          head="${{ github.sha }}"
          from=""
          to=""
          if [ "$event_name" = "pull_request" ]; then
            base_ref="${{ github.event.pull_request.base.ref }}"
            git fetch origin "$base_ref"
            from="origin/$base_ref"
            to="$head"
          else
            before="${{ github.event.before }}"
            if [ "$before" = "0000000000000000000000000000000000000000" ]; then
              from="$head"
            else
              from="$before"
            fi
            to="$head"
          fi
          echo "Linting commits from $from to $to"
          npx commitlint --from="$from" --to="$to"
