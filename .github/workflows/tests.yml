name: Tests
run-name: Tests

on:
  push: {}
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
      - name: Run go tests with coverage
        run: go test -coverprofile=coverage.out ./...
      - name: Generate coverage HTML
        run: go tool cover -html=coverage.out -o coverage.html
      - name: Build release binaries
        run: |
          set -euo pipefail
          TARGETS=(
            "linux amd64"
            "linux arm64"
            "darwin amd64"
            "darwin arm64"
            "windows amd64"
          )
          rm -rf dist
          mkdir -p dist
          for target in "${TARGETS[@]}"; do
            IFS=' ' read -r os arch <<< "$target"
            bin="agent-align-${os}-${arch}"
            if [ "$os" = windows ]; then
              bin="${bin}.exe"
            fi
            env GOOS="$os" GOARCH="$arch" CGO_ENABLED=0 go build -ldflags="-s -w" -o "dist/$bin" ./cmd/agent-align
            if [ "$os" = windows ]; then
              zip -j "dist/${bin}.zip" "dist/$bin"
              rm "dist/$bin"
            else
              tar -czf "dist/${bin}.tar.gz" -C dist "$bin"
              rm "dist/$bin"
            fi
          done
      - name: Prepare coverage site
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          RUN_ID: ${{ github.run_id }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          mkdir -p site
          if [ -d docs ]; then
            cp -R docs/. site/
          fi
          dest="site/coverage/${RUN_ID}"
          mkdir -p "$dest"
          cp coverage.html "$dest/index.html"
          cat <<EOF > "$dest/run.json"
          {"run_id": "${RUN_ID}", "commit": "${COMMIT_SHA}"}
EOF
          mkdir -p site/coverage
          cat <<EOF > site/coverage/index.html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Agent Align Coverage Reports</title>
</head>
<body>
  <h1>Agent Align Coverage Reports</h1>
  <p>Latest report: <a href="./${RUN_ID}/">Run ${RUN_ID}</a></p>
  <p>Commit: ${COMMIT_SHA}</p>
</body>
</html>
EOF
      - name: Setup GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/configure-pages@v5
      - name: Upload GitHub Pages artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: site
      - name: Deploy to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: deploy
        uses: actions/deploy-pages@v4
      - name: Announce coverage URL
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: echo "Coverage report: ${{ steps.deploy.outputs.page_url }}/coverage/${{ github.run_id }}/"
